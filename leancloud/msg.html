<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>在线聊天室</title>
		<script src="../js/av-min-1.0.0.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/realtime.browser.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/appkey.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var loginname = "";

			var realtime;
			window.onload = function() {
				var currentUser = AV.User.current();
				if(currentUser) {
					var Realtime = AV.Realtime;
					realtime = new Realtime({
						appId: APP_ID,
						region: 'cn', // 美国节点为 "us"
					});
					document.getElementById("username").innerHTML = currentUser.getUsername();
					//加入默认聊天室
					joinConversation(currentUser.getUsername());
				} else {
					location.href = "login.html";
				}
			}

			function queryMessages(conversation, limit) {
				conversation.queryMessages({
					limit: limit, // limit 取值范围 1~1000，默认 20
				}).then(function(messages) {
					// 最新的十条消息，按时间增序排列
					console.log(messages);
				}).catch(console.error.bind(console));
			}

			function countConversation(conversation) {
				conversation.count().then(function(count) {
					console.log('在线人数', count);
					document.getElementById("count").innerHTML = count;
				}).catch(console.error.bind(console));
			}

			function joinConversation(username) {
				realtime.createIMClient(username).then(function(user) {
					return user.getConversation(CONVERSATION_ID);
				}).then(function(conversation) {
					return conversation.join();
				}).then(function(conversation) {
					console.log('加入成功', conversation.members);
					//查询在线人数
					//					countConversation(conversation);
					//					queryMessages(conversation, 10);
				}).catch(console.error.bind(console));
			}

			function Create() {
				realtime.createIMClient(loginname).then(function(loginname) {
					loginname.createConversation({
						name: '聊天广场',
						transient: true,
					}).then(function(conversation) {
						alert('创建聊天室成功。id: ' + conversation.id);
					}).catch(console.error.bind(console));
				}).then(function(message) {
					console.log('聊天广场', '创建成功！');
				}).catch(console.error);

			}

			function exit() {

			}
		</script>
	</head>

	<body>
		<p>
			<h2>欢迎【<output id="username"></output>】回来</h2>
			<h2>在线人数：<output id="count"></output></h2>
			<input type="button" id="" value="退出" onclick="exit()" />
		</p>

		<p><textarea name="msg" style="width: 400px;height: 400px;"></textarea></p>
		<p>内容：<input type="text" id="send" /><input type="button" value="发送" /> </p>
	</body>

</html>